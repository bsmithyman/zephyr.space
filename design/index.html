<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Brendan Smithyman">
        <link rel="canonical" href="https://zephyr.space/design/">
        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>Overview - zephyr.space</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <link href="../css/base.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="..">zephyr.space</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="..">Intro</a>
                </li>
            
            
            
                <li >
                    <a href="../background/">Background</a>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Design <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li class="active">
                            <a href="./">Overview</a>
                        </li>
                    
                        <li >
                            <a href="../frontend/">Frontend / UI</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li >
                    <a href="../about/">About</a>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li >
                    <a rel="next" href="../background/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../frontend/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
                <li>
                    <a href="https://github.com/uwoseis/zephyr/">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#design">Design</a></li>
        
            <li><a href="#submodule-structure-and-design-goals">Submodule structure and design goals</a></li>
        
            <li><a href="#class-inheritance-graph">Class inheritance graph</a></li>
        
            <li><a href="#object-hierarchy-and-attributemapper">Object hierarchy and AttributeMapper</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="design">Design</h1>
<p>Zephyr is written to make heavy use of object-oriented programming techniques, including <a href="https://en.wikipedia.org/wiki/Multiple_inheritance">class multiple inheritance</a>. The majority of programming constructs in the Zephyr implementation are subclasses of <code>AttributeMapper</code>, which automatically handles configuring new objects based on a global <code>systemConfig</code> dictionary (i.e., a key/value store).<sup id="fnref:metaclass"><a class="footnote-ref" href="#fn:metaclass" rel="footnote">1</a></sup></p>
<p>The interrelation between different packages (i.e., sub-modules) and object classes in Zephyr is easiest to understand visually. The following graphs were designed using <code>pylint</code>'s <code>pyreverse</code> command, and can be recreated by running</p>
<div class="codehilite"><pre>make graphs
</pre></div>


<p>in the base directory of Zephyr's source code.</p>
<h2 id="submodule-structure-and-design-goals">Submodule structure and design goals</h2>
<p>This graph shows the linkages between Zephyr's submodules, including which submodules depend on others. It is important to note that <code>zephyr.backend</code> is intended to be minimally dependent on non-standard external packages, to enable solvers to be <a href="embedding.md">easily embedded in existing code</a>. The <code>zephyr.middleware</code> layer is dependent on features in SimPEG and other libraries to enable waveform inversion.</p>
<p><a href="../images/packages_zephyr.svg"><img alt="" src="../images/packages_zephyr_small.png" />
Click to expand</a></p>
<p>The <code>zephyr.frontend</code> layer is designed to encompass user-facing features, including the <a href="../frontend/">command-line interface</a>.</p>
<h2 id="class-inheritance-graph">Class inheritance graph</h2>
<p>This graph shows the interrelation between the object classes in Zephyr. The dependencies for <code>zephyr.backend</code> are largely internal, whereas several features of <code>zephyr.middleware</code> depend on SimPEG.</p>
<p><a href="../images/classes_zephyr.svg"><img alt="" src="../images/classes_zephyr_small.png" />
Click to expand</a></p>
<h2 id="object-hierarchy-and-attributemapper">Object hierarchy and <code>AttributeMapper</code></h2>
<p>An <code>AttributeMapper</code> subclass defines a dictionary <code>initMap</code>, which
includes keys for mappable inputs expected from the systemConfig
parameter. The class definition takes the form:</p>
<div class="codehilite"><pre><span class="k">class</span> <span class="nc">BaseModelDependent</span><span class="p">(</span><span class="n">AttributeMapper</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    AttributeMapper subclass that implements model-dependent properties,</span>
<span class="sd">    such as grid coordinates and free-surface conditions.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">initMap</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c">#   Argument        Required    Rename as ...   Store as type</span>
        <span class="s">&#39;nx&#39;</span><span class="p">:</span>           <span class="p">(</span><span class="bp">True</span><span class="p">,</span>      <span class="bp">None</span><span class="p">,</span>           <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
        <span class="s">&#39;ny&#39;</span><span class="p">:</span>           <span class="p">(</span><span class="bp">False</span><span class="p">,</span>     <span class="bp">None</span><span class="p">,</span>           <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
        <span class="s">&#39;nz&#39;</span><span class="p">:</span>           <span class="p">(</span><span class="bp">True</span><span class="p">,</span>      <span class="bp">None</span><span class="p">,</span>           <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
        <span class="s">&#39;xorig&#39;</span><span class="p">:</span>        <span class="p">(</span><span class="bp">False</span><span class="p">,</span>     <span class="s">&#39;_xorig&#39;</span><span class="p">,</span>       <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
        <span class="s">&#39;yorig&#39;</span><span class="p">:</span>        <span class="p">(</span><span class="bp">False</span><span class="p">,</span>     <span class="s">&#39;_xorig&#39;</span><span class="p">,</span>       <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
        <span class="s">&#39;zorig&#39;</span><span class="p">:</span>        <span class="p">(</span><span class="bp">False</span><span class="p">,</span>     <span class="s">&#39;_zorig&#39;</span><span class="p">,</span>       <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
        <span class="s">&#39;dx&#39;</span><span class="p">:</span>           <span class="p">(</span><span class="bp">False</span><span class="p">,</span>     <span class="s">&#39;_dx&#39;</span><span class="p">,</span>          <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
        <span class="s">&#39;dy&#39;</span><span class="p">:</span>           <span class="p">(</span><span class="bp">False</span><span class="p">,</span>     <span class="s">&#39;_dx&#39;</span><span class="p">,</span>          <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
        <span class="s">&#39;dz&#39;</span><span class="p">:</span>           <span class="p">(</span><span class="bp">False</span><span class="p">,</span>     <span class="s">&#39;_dz&#39;</span><span class="p">,</span>          <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
        <span class="s">&#39;freeSurf&#39;</span><span class="p">:</span>     <span class="p">(</span><span class="bp">False</span><span class="p">,</span>     <span class="s">&#39;_freeSurf&#39;</span><span class="p">,</span>    <span class="nb">tuple</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="o">...</span>
</pre></div>


<ul>
<li>
<p>Each value in the dictionary is a tuple, which is interpreted by
the <code>AttributeMapper</code><sup id="fnref:metaclass"><a class="footnote-ref" href="#fn:metaclass" rel="footnote">1</a></sup> to determine how to process the
value corresponding to the same key in <code>systemConfig</code>.</p>
</li>
<li>
<p>An exception will be raised if the first element in the tuple
is set to true, but the corresponding key does not exist in the
systemConfig parameter.</p>
</li>
<li>
<p>If the second element in the tuple is set to <code>None</code>, the key will be
defined in the subclass's attribute dictionary as it stands, whereas
if the second element is a string then that overrides the key.</p>
</li>
<li>
<p>If the third element in the tuple is set to <code>None</code>, the input argument
will be set in the subclass dictionary unmodified; however, if the
third element is a callable then it will be applied to the element
(e.g., to allow copying and/or typecasting of inputs).</p>
</li>
</ul>
<p>NB: Complex <code>numpy</code> arguments are handled specially: the real part of
the value is kept and the imaginary part is discarded when they are
typecast to a float.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:metaclass">
<p>In fact, most of the assembly of objects is handled by <code>zephyr.backend.meta.AMMetaClass</code>, which is the <a href="http://blog.ionelmc.ro/2015/02/09/understanding-python-metaclasses/">metaclass</a> for <code>AttributeMapper</code> and its descendants. All of this happens before the call to <code>AttributeMapper.__init__</code>. This enables the <code>initMap</code> class attribute to be merged automatically and inherit keys from the subclass's bases.&#160;<a class="footnote-backref" href="#fnref:metaclass" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div></div>
        </div>

        <footer class="col-md-12">
            <hr>
            
                <center>© 2014–2015 Brendan Smithyman</center>
            
            <center>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</center>
        </footer>

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script src="../js/base.js"></script>
        <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
        <script src="../scripts/mathjaxhelper.js"></script>
    </body>
</html>